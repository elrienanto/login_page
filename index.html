<script>
    // Initialize dataLayer
    window.dataLayer = window.dataLayer || [];

    let userData = {};

    function setCookie(name, value, days) {
        const expires = new Date(Date.now() + days * 864e5).toUTCString();
        document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
    }

    function getCookie(name) {
        return document.cookie.split('; ').reduce((r, v) => {
            const parts = v.split('=');
            return parts[0] === name ? decodeURIComponent(parts[1]) : r
        }, '');
    }

    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;

        userData = {
            user_id: email,
            name: name,
            email: email,
            phone: phone
        };

        // Push to GTM dataLayer
        window.dataLayer.push({
            event: 'logged_in',
            ...userData
        });

        console.log('Logged in event fired:', userData);

        // Store user data in cookies for persistence
        setCookie('userLoginData', JSON.stringify(userData), 7);

        document.getElementById('subscriptionBtn').disabled = false;
        document.getElementById('subscriptionBtn').textContent = 'Go to Subscription';
    });

    document.getElementById('subscriptionBtn').addEventListener('click', function() {
        if (Object.keys(userData).length === 0) {
            const cookieData = getCookie('userLoginData');
            if (cookieData) {
                try {
                    userData = JSON.parse(cookieData);
                } catch (err) {
                    console.warn('Invalid cookie data');
                }
            }
        }

        if (!userData.user_id) {
            alert('Please login first!');
            return;
        }

        // Push subscription event to dataLayer
        window.dataLayer.push({
            event: 'subscription_initiated',
            ...userData
        });

        console.log('Subscription initiated event fired');

        sessionStorage.setItem('userData', JSON.stringify(userData));
        window.location.href = 'https://elrienanto.github.io/subscription_page';
    });

    // // ðŸ“Œ Placeholder: WebEngage Cookie Integration
    // function checkWebEngageCookie() {
    //     const weUserId = getCookie('_we_wk'); // Replace with actual cookie key used by WebEngage
    //     if (weUserId) {
    //         console.log('WebEngage cookie found:', weUserId);
    //         // You can map it to userData or fire another GTM event here
    //     } else {
    //         console.log('WebEngage cookie not found');
    //     }
    // }

    // Call this on load or after WebEngage loads
    window.addEventListener('load', checkWebEngageCookie);
</script>
